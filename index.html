<!DOCTYPE html>
<html>

<head>
	<link rel="icon" href="/favicon.svg" type="image/svg+xml"/>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">

    <meta name='description' content="Cryption online against censorship. ">
    <meta name='keywords' content="crypt,cryption,censor,china,gfw">

    <!-- web app -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- theme color-->
    <meta name="theme-color" content="#39c5bb" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)">

    <!-- fav icon -->
    <link rel="shortcut icon" href="./favicon.svg" type="image/svg+xml">

    <!-- apple-touch-icon -->
    <link rel="/favicon.svg" type="image/svg+xml">
    <!-- mask-icon 目前非必须 -->
    <link rel="mask-icon" href="./appicon-apple.png">

    <title>Cryption</title>

	<meta name="viewport"
		content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<style>
		body {
			display: flex;
			flex-direction: column;
			align-items: center;
			margin: 0;
			padding: 0;
			font-family: Arial, sans-serif;
			background-color: #39c5bb;
		}
	</style>
</head>

<body>
	<script src="./Crypt.js"></script>
	<input id="BtChange" type="button" value="处理图片" onclick="ChangeCryption();">
	<br />
	<input id="BtEncrypt" type="button" value="加密" onclick="Encrypt();" />
	<input id="BtDecrypt" type="button" value="解密" onclick="Decrypt();" />
	<input id="EdPassword" type="text" value="1976" onchange="SetPassword();" />
	<input id="BtSetPassword" type="button" value="设置密码" onclick="SetPassword();" />
	<br />
	<div id="ProcessStrArea">
		<p>请在下方输入需要处理的文字</p>
		<br />
		<textarea id="EdStr" rows="10" cols="50"></textarea>
	</div>


	<br />
	<div id="PicBtArea" hidden=true>
		<input type="button" value="关闭/打开预览" onclick="SetPreview();" hidden="true" id="SwPreview" />
		<input type="file" accept="image/*" name="picture" id="pic-upload" onchange="UploadImage(this)" />
		<input type="button" value="下载图片" onclick="DownloadImage();" id="BtDownload" hidden="true" />
	</div>
	<div id="PreviewArea" hidden=true>
		<br />
		<canvas id="canvas" width="0" height="0"></canvas>
		<br />
		<script>
			function isMobile() {
				if (window.navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)) {
					return true; // 移动端
				} else {
					return false; // PC端
				}
			}
			if (isMobile()) {
				document.getElementById("PreviewArea").hidden = true;
			}
			let PicFileName = null;
			function UploadImage(fileObj) {
				document.getElementById("SwPreview").hidden = false;
				PicFileName = fileObj.files[0].name;
				var reader = new FileReader();
				// 转换成功后的操作，img.src即为转换后的DataURL
				reader.onload = function (e) {
					if (reader.readyState === 2) { //加载完毕后赋值
						var img = new Image(); //获得用户上传的图片节点
						img.src = e.target.result;
						img.onload = function () {
							document.getElementById("BtDownload").hidden = false;
							let cvs = document.getElementById("canvas");
							let ctx = cvs.getContext("2d");
							cvs.width = img.width;
							cvs.height = img.height;
							ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
							if (document.getElementById("PreviewArea").hidden == true)
								alert("图片上传成功");
						}
					}
				}
				reader.readAsDataURL(fileObj.files[0]);
			}
		</script>
	</div>
	<br />


	<style>
		.file-upload {
			display: none;
		}
	</style>

	<script>
		let CryptionProcess = "str";
		function ChangeCryption() {
			var BtChange = document.getElementById("BtChange");
			if (BtChange.value == "处理图片") {
				BtChange.value = "处理文字";
				CryptionProcess = "img";
				document.getElementById("PicBtArea").hidden = false;
				document.getElementById("PreviewArea").hidden = false;
				document.getElementById("ProcessStrArea").hidden = true;
			}
			else if (BtChange.value == "处理文字") {
				BtChange.value = "处理图片";
				CryptionProcess = "str";
				document.getElementById("PicBtArea").hidden = true;
				document.getElementById("PreviewArea").hidden = true;
				document.getElementById("ProcessStrArea").hidden = false;
			}
		}

		function Encrypt() {
			if (CryptionProcess == "str") {
				var EdStr = document.getElementById("EdStr");
				var str = EdStr.value;
				var result = ProcessStr(str, 1);
				EdStr.value = result;
			}
			else if (CryptionProcess == "img") {
				var canvas = document.getElementById("canvas");
				var result = ProcessCanvas(canvas, 1);
				if (document.getElementById("PreviewArea").hidden == true)
					alert("图片处理完成");
			}
		}

		function Decrypt() {
			if (CryptionProcess == "str") {
				var EdStr = document.getElementById("EdStr");
				var str = EdStr.value;
				var result = ProcessStr(str, -1);
				EdStr.value = result;
			}
			else if (CryptionProcess == "img") {
				var canvas = document.getElementById("canvas");
				var result = ProcessCanvas(canvas, -1);
				if (document.getElementById("PreviewArea").hidden == true)
					alert("图片处理完成");
			}
		}

		function DownloadImage() {
			var canvas = document.getElementById("canvas");
			var img = canvas.toDataURL("image/png");
			var a = document.createElement("a");
			a.href = img;
			a.download = PicFileName + ".crypted.png";
			a.click();
		}

		function SetPassword() {
			var EdPassword = document.getElementById("EdPassword");
			var password = Number(EdPassword.value);
			if (Object.is(password, NaN)) {
				alert("密码必须为数字");
				EdPassword.value = "1976";
			}
			else
				ChgPass(password);
		}

		function SetPreview() {
			var canvas = document.getElementById("PreviewArea");
			canvas.hidden = !canvas.hidden;
		}

	</script>
</body>

</html>